{% extends 'layout/2column.html' %}

{% block html_title %}{{ path|path2name }} · {{ path }}{% endblock %}

{% block content_head %}

{% block content_head_before %}
{% endblock %}

<div class="header-wrap">
  {% if not page.isDeleted() %}
  <header id="page-header">
    <p class="stopper"><a href="#" data-affix-disable="#page-header"><i class="fa fa-chevron-up"></i></a></p>
    {% if page %}
      {% if page.joinAble %}
        {% if page.isJoined(user) %}
          <a href="#" title="Join" class="join-link btn btn-danger" id="join-button" data-joined="true">参加しない</a>
        {% else %}
          <a href="#" title="Join" class="join-link btn btn-default" id="join-button" data-joined="false">参加</a>
        {% endif %}
      {% endif %}
    {% endif %}
    <h1 class="title" id="revision-path">{{ path|insertSpaceToEachSlashes }}</h1>
    <input type="hidden" id="here-path" value="{{ path +'/' }}">
    <input type="text" id="next-page-name" value="">
    <input type="button" id="add-next-page" value="ページを追加">
    <form action="/_/edit" method="post" id="create-next-page">
      <input type="hidden" name="pageForm[body]" id="next-page-body" value="">
      <input type="hidden" name="pageForm[path]" id="next-page-path" value="">
      <input type="hidden" name="pageForm[grant]" id="next-page-grant" value="1">
      <input type="hidden" name="_csrf" value="{{ _csrf() }}">
      <input type="hidden" name="pageForm[currentRevision]" id="next-page-currentRevision" value>
    </form>
  </header>
  {% else %}
  {# trash/* #}
  <header id="page-header">
    <h1 class="title">{{ path|insertSpaceToEachSlashes }}</h1>
  </header>
  {% endif %}
</div>

{% block content_head_after %}
{% endblock %}

{% endblock %}

{% block content_main %}

{% block content_main_before %}
{% endblock %}

<div id="content-main" class="content-main {% if not page or req.body.pageForm %}on-edit{% endif %}"
  data-path="{{ path }}"
  data-path-shortname="{{ path|path2name }}"
  data-page-id="{% if page %}{{ page._id.toString() }}{% endif %}"
  data-current-user="{% if user %}{{ user._id.toString() }}{% endif %}"
  data-page-revision-id="{% if revision %}{{ revision._id.toString() }}{% endif %}"
  data-page-revision-created="{% if revision %}{{ revision.createdAt|datetz('U') }}{% endif %}"
  data-page-is-seen="{% if page and page.isSeenUser(user) %}1{% else %}0{% endif %}"
  >

  {% if not page %}
  <ul class="nav nav-tabs hidden-print">
    <li><a>Create: {{ path }}</a></li>
    <li class="dropdown pull-right">
      <a href="/"><i class="fa fa-times"></i> キャンセル</a>
    </li>
  </ul>
  <div class="tab-content">
    <div class="edit-form">
    {% include '_form.html' %}
    </div>
  </div>

  {% else %}

  {% if page.isDeleted() %}
  <div class="alert alert-danger">
    <form role="form" class="pull-right" id="revert-delete-page-form" onsubmit="return false;">
      <input type="hidden" name="_csrf" value="{{ _csrf() }}">
      <input type="hidden" name="path" value="{{ page.path }}">
      <input type="hidden" name="page_id" value="{{ page._id.toString() }}">
      <input type="submit" class="btn btn-danger btn-inverse btn-sm" value="Put Back!">
    </form>
    <p>
      <i class="fa fa-trash-o" aria-hidden="true"></i>
      This page is in the trash.<br>
    </p>
    <p>
    Deleted by <img src="{{ page.lastUpdateUser|picture }}" class="picture picture-sm picture-rounded"> {{ page.lastUpdateUser.name }} at {{ page.updatedAt|datetz('Y-m-d H:i:s') }}
    </p>
  </div>
  {% endif %}

  {% if not page.isDeleted() %}
  <ul class="nav nav-tabs hidden-print">
    <li class=" {% if not req.body.pageForm %}active{% endif %}" data-toggle="tooltip" {# data-title="あなたの 確認待ち です" title="" data-placement="bottom" data-trigger="manual" data-tooltip-stay #}>
      <a href="#revision-body" data-toggle="tab">
      <i class="fa fa-magic"></i>
      {#
        <img src="//graph.facebook.com/588883490/picture?size=square" width="16"> <i class="fa fa-arrow-right"></i> <img src="//graph.facebook.com/588883490/picture?size=square" width="16">
        <span class="label label-danger" style=""> 承認待ち</span>
      #}
      </a>
    </li>

    {% if not pageUser or page.isCreator(user) or user.admin %}
    <li {% if req.body.pageForm %}class="active"{% endif %}><a href="#edit-form" data-toggle="tab"><i class="fa fa-pencil-square-o"></i> 編集</a></li>
    {% endif %}


    <li class="dropdown pull-right">
      <a class="dropdown-toggle" data-toggle="dropdown" href="#">
        <i class="fa fa-wrench"></i> <span class="caret"></span>
      </a>
      <ul class="dropdown-menu">
       <li><a href="#" data-target="#renamePage" data-toggle="modal"><i class="fa fa-share"></i> 移動</a></li>
       <li><a href="?presentation=1" class="toggle-presentation"><i class="fa fa-arrows-alt"></i> プレゼンモード (beta)</a></li>
       {% if isDeletablePage() %}
       <li class="divider"></li>
       {% if page.joinAble %}
         <li><a href="#" id="joinable-link" data-joinable="true"><i class="fa fa-user"> 参加不可能にする</i></a></li>
       {% else %}
         <li><a href="#" id="joinable-link" data-joinable="false"><i class="fa fa-user"> 参加可能にする</i></a></li>
       {% endif %}
       <li class="divider"></li>
       <li class=""><a href="#" data-target="#deletePage" data-toggle="modal"><i class="fa fa-trash-o text-danger"></i> 削除</a></li>
       {% endif %}
      </ul>
    </li>
    {% if page %}
    <li class="pull-right"><a href="#revision-history" data-toggle="tab"><i class="fa fa-history"></i> History</a></li>
    {% endif %}
  </ul>
  {% endif %}

  {% include 'modal/widget_rename.html' %}
  {% include 'modal/widget_delete.html' %}

  <div class="tab-content wiki-content">
  {% if req.query.renamed and not page.isDeleted() %}
  <div class="alert alert-info">
    <strong>移動しました: </strong> このページは <code>{{ req.query.renamed }}</code> から移動しました。
  </div>
  {% endif %}
  {% if not page.isLatestRevision() %}
  <div class="alert alert-warning">
    <strong>注意: </strong> これは現在の版ではありません。 <i class="fa fa-magic"></i> <a href="{{ page.path }}">最新のページを表示</a>
  </div>
  {% endif %}

{#
  <div class="panel panel-default">
    <div class="panel-heading">承認待ち</div>
    <div class="panel-body">
      ほげほげ
    </div>
  </div>
#}
    <script type="text/template" id="raw-text-original">{{ revision.body }}</script>

    {# formatted text #}
    <div class="tab-pane {% if not req.body.pageForm %}active{% endif %}" id="revision-body">
      <div class="revision-toc" id="revision-toc">
        <a data-toggle="collapse" data-parent="#revision-toc" href="#revision-toc-content" class="revision-toc-head collapsed">目次</a>

      </div>
      <div class="wiki {{ revision.format }}" id="revision-body-content"></div>
    </div>

    {# edit form #}
    {% if not page.isDeleted() %}
    <div class="edit-form tab-pane {% if req.body.pageForm %}active{% endif %}" id="edit-form">
      {% include '_form.html' %}
    </div>
    {% endif %}

    {# raw revision history #}
    <div class="tab-pane revision-history" id="revision-history">
      <h1><i class="fa fa-history"></i> History</h1>
      {% if not page %}
      {% else %}
      <div class="revision-history-list">
        {% for t in tree %}
        <div class="revision-hisory-outer">
          <img src="{{ t.author|picture }}" class="picture picture-rounded">
          <div class="revision-history-main">
            <div class="revision-history-author">
              <strong>{% if t.author %}{{ t.author.username }}{% else %}-{% endif %}</strong>
            </div>
            <div class="revision-history-comment">
            </div>
            <div class="revision-history-meta">
              {{ t.createdAt|datetz('Y-m-d H:i:s') }}
              <br>
              <a href="?revision={{ t._id.toString() }}"><i class="fa fa-history"></i> このバージョンを見る</a>
              <a class="diff-view" data-revision-id="{{ t._id.toString() }}">
                <i id="diff-icon-{{ t._id.toString() }}" class="fa fa-arrow-circle-right"></i> 差分を見る
              </a>
              <pre class="" id="diff-display-{{ t._id.toString()}}" style="display: none"></pre>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}

    </div>

  </div>
  {% endif %}

<div id="notifPageEdited" class="fk-notif fk-notif-danger"><i class="fa fa-exclamation-triangle"></i> <span class="edited-user"></span>さんがこのページを編集しました。 <a href="javascript:location.reload();"><i class="fa fa-angle-double-right"></i> 最新版を読み込む</a></div>
</div>

{% block content_main_after %}
{% endblock %}

{% endblock %}

{% block content_footer %}


<div class="page-attachments meta">
  <p>Attachments</p>
  <ul>
  </ul>
</div>

<p class="meta">
  Path: <span id="pagePath">{{ page.path }}</span><br>
  {# for BC #}
  {% if page.lastUpdateUser %}
    Last updated at {{ page.updatedAt|datetz('Y-m-d H:i:s') }} by <img src="{{ page.lastUpdateUser|picture }}" class="picture picture-rounded"> {{ page.lastUpdateUser.name }}<br>
  {% else %}
    Last updated at {{ page.revision.createdAt|datetz('Y-m-d H:i:s') }} by <img src="{{ page.revision.author|picture }}" class="picture picture-rounded"> {{ page.revision.author.name }}<br>
  {% endif %}
  {# /for BC #}
  Created at {{ page.createdAt|datetz('Y-m-d H:i:s') }} by <img src="{{ page.creator|default(page.creator)|picture }}" class="picture picture-rounded"> {{ page.creator.name }}<br>
</p>

{% endblock %}

{% block side_header %}
  {% if not page.isDeleted() %}
    {% include 'widget/page_side_header.html' %}
  {% endif %}
{% endblock %} {# side_header #}

{% block side_content %}
  {% if not page.isDeleted() %}
    {% include 'widget/page_side_content.html' %}
  {% endif %}
{% endblock %}

{% block footer %}
{% endblock %}

{% block body_end %}
  {% parent %}

  <div id="presentation-layer" class="fullscreen-layer">
    <div id="presentation-container"></div>
  </div>
{% endblock %}
